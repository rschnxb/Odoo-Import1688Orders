# Odoo 1688采购订单导入模块

这是一个用于从1688（阿里巴巴中国站）导出的Excel文件导入采购订单到Odoo 16的自定义模块。

## 功能特性

- ✅ 从1688导出的Excel文件导入采购订单
- ✅ 自动创建或匹配供应商
- ✅ 自动创建或匹配产品
- ✅ 支持一个订单包含多个产品行
- ✅ **运费处理**：自动将运费添加为单独的订单行
- ✅ **无税率**：默认不添加税率，避免价格重复计算
- ✅ 直接使用Excel中的价格数据，无需二次计算
- ✅ 自动记录1688订单详细信息（运单号、物流公司、买家留言等）
- ✅ 提供详细的导入摘要报告

## 安装要求

### 系统依赖

- Odoo 16.0
- Python 3.8+

### Python依赖

```bash
pip install openpyxl
```

或者在Odoo服务器上：

```bash
pip3 install openpyxl
```

## 安装步骤

1. 将 `odoo_1688_import` 文件夹复制到Odoo的addons目录

2. 重启Odoo服务

3. 在Odoo后台激活开发者模式：
   - 设置 → 激活开发者模式

4. 更新应用列表：
   - 应用 → 更新应用列表

5. 搜索并安装"1688采购订单导入"模块：
   - 应用 → 搜索 "1688" → 安装

## 使用方法

### 1. 从1688导出订单

1. 登录1688采购平台
2. 进入"我的订单"
3. 选择需要导出的订单
4. 点击"导出Excel"

### 2. 在Odoo中导入订单

1. 登录Odoo系统

2. 进入采购模块：
   ```
   采购 → 导入1688订单
   ```

3. 上传从1688导出的Excel文件

4. 点击"开始导入"按钮

5. 等待导入完成，系统会显示导入摘要

6. 点击"查看采购订单"查看新创建的采购订单

### 3. 验证导入结果

导入完成后，您可以：

- 在采购订单列表中看到新创建的订单（订单来源标记为"1688-订单编号"）
- 在订单备注中查看1688订单的详细信息
- 检查自动创建的供应商和产品

## Excel文件格式

模块支持1688标准导出格式，包含以下关键字段：

| 字段 | 列 | 说明 |
|------|------|------|
| 订单编号 | A | 1688订单编号（唯一标识） |
| 卖家公司名 | D | 供应商公司名称 |
| 卖家会员名 | E | 供应商会员名 |
| 运费(元) | G | 订单运费（会作为单独行添加到采购单） |
| 实付款(元) | I | 订单实付款金额（参考信息，记录在备注中） |
| 货品标题 | S | 产品名称 |
| 单价(元) | T | 产品单价（直接使用此价格） |
| 数量 | U | 订购数量 |
| 货号 | W | 产品编码 |
| SKU ID | Z | 产品SKU标识 |
| 运单号 | AF | 物流运单号 |
| 物流公司 | AE | 物流公司名称 |

## 数据映射规则

### 供应商匹配

- 优先根据**卖家公司名**精确匹配现有供应商
- 如果找不到匹配的供应商，自动创建新供应商
- 新供应商会在备注中记录会员名等信息

### 产品匹配

1. 首先根据**货号**匹配现有产品
2. 如果找不到，根据**SKU ID**匹配
3. 如果都找不到，自动创建新产品
4. 新产品会在采购说明中记录型号、SKU ID等信息

### 订单创建

- 订单来源字段：`1688-{订单编号}`
- 订单日期：使用1688订单创建时间
- 订单备注：包含所有1688订单详细信息
- **税率处理**：默认不添加税率（taxes_id设为空）

### 价格和运费处理

#### 价格调整算法：

```
1. 计算货品理论总价 = Σ(单价 × 数量)
2. 获取实付款金额（I列）
3. 获取运费金额（G列）
4. 计算货品实际总价 = 实付款 - 运费
5. 计算价格调整比例 = 货品实际总价 / 货品理论总价
6. 调整后单价 = 原单价 × 价格调整比例
```

**示例**：
- 产品A：单价 ¥10，数量 5 → 理论金额 ¥50
- 产品B：单价 ¥20，数量 3 → 理论金额 ¥60
- 货品理论总价：¥110
- 涨价或折扣：-¥10（折扣）
- 运费：¥15
- 实付款：¥115
- 货品实际总价：¥115 - ¥15 = ¥100
- 价格调整比例：¥100 / ¥110 = 0.909
- 产品A调整后单价：¥10 × 0.909 = ¥9.09
- 产品B调整后单价：¥20 × 0.909 = ¥18.18

#### 运费处理：

- 运费作为单独的订单行添加
- 自动创建或使用已有的"运费"服务类产品
- 产品编码：`SHIPPING-FEE`
- 运费金额直接使用Excel中的运费字段

## 目录结构

```
odoo_1688_import/
├── __init__.py                          # 模块初始化
├── __manifest__.py                       # 模块清单
├── models/
│   └── __init__.py                      # 模型初始化（目前无自定义模型）
├── wizard/
│   ├── __init__.py                      # 向导初始化
│   ├── import_1688_orders.py           # 导入逻辑（核心文件）
│   └── import_1688_orders_views.xml    # 导入向导视图
├── views/
│   └── menu_views.xml                   # 菜单定义
├── security/
│   └── ir.model.access.csv             # 访问权限
└── static/
    └── description/
        └── icon.png                     # 模块图标（可选）
```

## 核心功能说明

### 导入向导 (import.1688.orders)

主要方法：

- `action_import()`: 主导入流程入口
- `_parse_excel_data()`: 解析Excel数据
- `_create_purchase_orders()`: 创建采购订单
- `_calculate_price_adjustment()`: 计算价格调整比例（处理折扣/涨价）
- `_get_or_create_shipping_product()`: 获取或创建运费产品
- `_get_or_create_partner()`: 获取或创建供应商
- `_get_or_create_product()`: 获取或创建产品
- `_generate_notes()`: 生成订单备注
- `_generate_summary()`: 生成导入摘要

## 常见问题

### 1. 导入失败：ModuleNotFoundError: No module named 'openpyxl'

**解决方案**：安装openpyxl库
```bash
pip3 install openpyxl
```

### 2. 供应商重复创建

**原因**：供应商名称不完全匹配
**解决方案**：
- 在导入前手动创建供应商，确保名称与Excel中的"卖家公司名"完全一致
- 或者在导入后合并重复的供应商

### 3. 产品重复创建

**原因**：产品编码不匹配
**解决方案**：
- 确保现有产品的"内部编号"字段与Excel中的"货号"或"SKU ID"一致
- 或者在导入后合并重复的产品

### 4. Excel格式不支持

**原因**：1688可能更新了导出格式
**解决方案**：
- 检查Excel文件是否为1688标准格式
- 联系开发者更新模块以支持新格式

## 技术支持

如有问题或建议，请联系：
- 邮箱：support@yourcompany.com
- GitHub：https://github.com/yourcompany/odoo-1688-import

## 版本历史

### v16.0.1.1.0 (2024-11-10)
- 新增：智能价格调整功能，自动处理折扣和涨价
- 新增：运费自动添加为单独订单行
- 改进：默认不添加税率，避免价格重复计算
- 优化：价格计算更加精确，与1688实付款完全匹配

### v16.0.1.0.0 (2024-06-24)
- 初始版本
- 支持基本的1688订单导入功能
- 自动创建供应商和产品

## 许可证

LGPL-3

## 作者

Your Company

---

**注意**：本模块为第三方开发，非1688或Odoo官方产品。使用前请先在测试环境中验证功能。
