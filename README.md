# Odoo 1688采购订单导入模块

这是一个用于从1688（阿里巴巴中国站）导出的Excel文件导入采购订单到Odoo 16的自定义模块。

## 功能特性

- ✅ 从1688导出的Excel文件导入采购订单
- ✅ 自动创建或匹配供应商
- ✅ **Odoo商品编号匹配**：使用Excel中的"Odoo 商品编号"(AA列)精确匹配产品
- ✅ **智能跳过机制**：产品编号为空或不存在时跳过并提示，不自动创建产品
- ✅ 支持一个订单包含多个产品行
- ✅ **货币选择**：支持选择采购订单货币，默认为人民币(CNY)
- ✅ **运费智能分摊**：自动按比例将运费分摊到各产品单价中
- ✅ **无税率**：默认不添加税率，避免价格重复计算
- ✅ 直接使用Excel中的价格数据，无需二次计算
- ✅ 自动记录1688订单详细信息（运单号、物流公司、买家留言等）
- ✅ 提供详细的导入摘要报告，包括跳过的产品行明细

## 安装要求

### 系统依赖

- Odoo 16.0
- Python 3.8+

### Python依赖

```bash
pip install openpyxl
```

或者在Odoo服务器上：

```bash
pip3 install openpyxl
```

## 安装步骤

1. 将 `odoo_1688_import` 文件夹复制到Odoo的addons目录

2. 重启Odoo服务

3. 在Odoo后台激活开发者模式：
   - 设置 → 激活开发者模式

4. 更新应用列表：
   - 应用 → 更新应用列表

5. 搜索并安装"1688采购订单导入"模块：
   - 应用 → 搜索 "1688" → 安装

## 使用方法

### 1. 从1688导出订单

1. 登录1688采购平台
2. 进入"我的订单"
3. 选择需要导出的订单
4. 点击"导出Excel"

### 2. 在Odoo中导入订单

1. 登录Odoo系统

2. 进入采购模块：
   ```
   采购 → 导入1688订单
   ```

3. 上传从1688导出的Excel文件

4. 选择采购订单货币（默认为人民币CNY，1688订单通常使用人民币）

5. 点击"开始导入"按钮

6. 等待导入完成，系统会显示导入摘要

7. 点击"查看采购订单"查看新创建的采购订单

### 3. 验证导入结果

导入完成后，您可以：

- 在采购订单列表中看到新创建的订单（订单来源标记为"1688-订单编号"）
- 在订单备注中查看1688订单的详细信息
- 检查自动创建的供应商和产品

## Excel文件格式

模块支持1688标准导出格式，包含以下关键字段：

| 字段 | 列 | 说明 | 必填 |
|------|------|------|------|
| 订单编号 | A | 1688订单编号（唯一标识） | 是 |
| 卖家公司名 | D | 供应商公司名称 | 是 |
| 卖家会员名 | E | 供应商会员名 | 否 |
| 运费(元) | G | 订单运费（会按比例分摊到产品单价） | 否 |
| 实付款(元) | I | 订单实付款金额（参考信息，记录在备注中） | 否 |
| 货品标题 | S | 产品名称 | 是 |
| 单价(元) | T | 产品单价（将加上分摊的运费） | 是 |
| 数量 | U | 订购数量 | 是 |
| 货号 | W | 产品编码（参考信息） | 否 |
| SKU ID | Z | 产品SKU标识（参考信息） | 否 |
| **Odoo 商品编号** | **AA** | **Odoo产品Internal Reference（必须填写）** | **是** |
| 运单号 | AF | 物流运单号 | 否 |
| 物流公司 | AE | 物流公司名称 | 否 |

**⚠️ 重要说明**：
- **AA列"Odoo 商品编号"为必填项**，必须填写Odoo系统中已存在产品的Internal Reference
- 如果AA列为空，该产品行将被跳过，不会自动创建新产品
- 如果AA列的值在Odoo系统中不存在，该产品行也会被跳过

## 数据映射规则

### 供应商匹配

- 优先根据**卖家公司名**精确匹配现有供应商
- 如果找不到匹配的供应商，自动创建新供应商
- 新供应商会在备注中记录会员名等信息

### 产品匹配

**新的匹配规则（重要变更）**：

1. **仅根据"Odoo 商品编号"(AA列)匹配产品**
2. 系统会查找`default_code`（Internal Reference）字段与AA列值完全匹配的产品
3. **如果AA列为空**：该产品行将被跳过，并在导入摘要中显示警告
4. **如果AA列的值在系统中不存在**：该产品行将被跳过，并在导入摘要中显示警告
5. **不再自动创建产品**：所有产品必须在Odoo系统中预先创建好

**为什么需要预先填写Odoo商品编号？**
- 确保产品信息的准确性和一致性
- 避免重复创建产品
- 便于手动审核和管理
- 产品信息（成本、供应商等）需要提前在Odoo中配置

### 订单创建

- 订单来源字段：`1688-{订单编号}`
- 订单日期：使用1688订单创建时间
- 订单货币：使用导入时选择的货币（默认为人民币CNY）
- 订单备注：包含所有1688订单详细信息
- **税率处理**：默认不添加税率（taxes_id设为空）

### 价格和运费处理

#### 价格处理：

- 使用Excel中T列的"单价(元)"作为基础单价
- 运费会按比例分摊到各产品的单价中
- 最终的产品单价 = 原始单价 + 分摊的运费

#### 运费分摊算法：

**运费按产品金额比例分摊到各产品单价中**

```
1. 计算所有产品的总金额：
   总金额 = Σ(单价 × 数量)

2. 计算每个产品应分摊的运费：
   产品金额 = 单价 × 数量
   分摊运费 = (产品金额 / 总金额) × 订单运费

3. 计算含运费的单价：
   最终单价 = 原始单价 + (分摊运费 / 数量)
```

**示例**：
```
订单运费：¥50

产品A：单价 ¥100，数量 2 → 金额 ¥200
产品B：单价 ¥150，数量 1 → 金额 ¥150
总金额：¥350

产品A分摊运费：(¥200 / ¥350) × ¥50 = ¥28.57
产品A最终单价：¥100 + (¥28.57 / 2) = ¥114.29

产品B分摊运费：(¥150 / ¥350) × ¥50 = ¥21.43
产品B最终单价：¥150 + (¥21.43 / 1) = ¥171.43

采购订单总金额：¥114.29 × 2 + ¥171.43 = ¥400
```

**优点**：
- 运费自动分摊到产品成本中
- 采购订单结构简洁，无需单独的运费行
- 产品成本核算更准确

## 目录结构

```
odoo_1688_import/
├── __init__.py                          # 模块初始化
├── __manifest__.py                       # 模块清单
├── models/
│   └── __init__.py                      # 模型初始化（目前无自定义模型）
├── wizard/
│   ├── __init__.py                      # 向导初始化
│   ├── import_1688_orders.py           # 导入逻辑（核心文件）
│   └── import_1688_orders_views.xml    # 导入向导视图
├── views/
│   └── menu_views.xml                   # 菜单定义
├── security/
│   └── ir.model.access.csv             # 访问权限
└── static/
    └── description/
        └── icon.png                     # 模块图标（可选）
```

## 核心功能说明

### 导入向导 (import.1688.orders)

主要方法：

- `action_import()`: 主导入流程入口
- `_get_default_currency()`: 获取默认货币（人民币CNY）
- `_parse_excel_data()`: 解析Excel数据（含AA列Odoo商品编号）
- `_create_purchase_orders()`: 创建采购订单（含运费分摊逻辑）
- `_find_product_by_reference()`: 根据Odoo商品编号查找产品
- `_get_or_create_partner()`: 获取或创建供应商
- `_generate_notes()`: 生成订单备注
- `_generate_summary()`: 生成导入摘要（含跳过产品行明细）

## 常见问题

### 1. 导入失败：ModuleNotFoundError: No module named 'openpyxl'

**解决方案**：安装openpyxl库
```bash
pip3 install openpyxl
```

### 2. 产品行被跳过：Excel中Odoo商品编号(AA列)为空

**原因**：AA列未填写Odoo产品的Internal Reference
**解决方案**：
1. 在Excel的AA列填写对应产品在Odoo系统中的Internal Reference
2. 如何查找产品的Internal Reference：
   - 在Odoo中进入：库存 → 产品
   - 打开产品详情，查看"Internal Reference"字段
3. 填写完成后重新导入Excel文件

### 3. 产品行被跳过：在Odoo系统中未找到该产品

**原因**：AA列填写的Internal Reference在Odoo系统中不存在
**解决方案**：
1. 检查AA列的值是否与Odoo产品的Internal Reference完全匹配（大小写敏感）
2. 如果产品不存在，需要先在Odoo中创建该产品：
   - 进入：库存 → 产品 → 创建
   - 填写产品信息，特别是"Internal Reference"字段
   - 保存产品
3. 确认产品创建后，在Excel的AA列填写该Internal Reference
4. 重新导入Excel文件

### 4. 供应商重复创建

**原因**：供应商名称不完全匹配
**解决方案**：
- 在导入前手动创建供应商，确保名称与Excel中的"卖家公司名"完全一致
- 或者在导入后合并重复的供应商

### 5. Excel格式不支持

**原因**：1688可能更新了导出格式
**解决方案**：
- 检查Excel文件是否为1688标准格式
- 联系开发者更新模块以支持新格式

## 技术支持

如有问题或建议，请联系：
- 邮箱：support@yourcompany.com
- GitHub：https://github.com/yourcompany/odoo-1688-import

## 版本历史

### v16.0.2.0.0 (2024-11-16)
- **重大变更**：新增AA列"Odoo 商品编号"，必须填写产品Internal Reference
- **重大变更**：不再自动创建产品，产品编号为空或不存在时跳过并提示
- **改进**：运费按比例智能分摊到产品单价中
- 新增：详细的跳过产品行提示和导入摘要
- 改进：更精确的产品匹配逻辑
- 改进：支持部分成功状态（有产品行被跳过）

### v16.0.1.2.0 (2024-11-16)
- 新增：货币选择功能，默认为人民币(CNY)
- 改进：直接使用Excel中的价格数据，无需二次计算
- 改进：默认不添加税率

### v16.0.1.1.0 (2024-11-10)
- 新增：运费自动添加为单独订单行
- 改进：默认不添加税率，避免价格重复计算

### v16.0.1.0.0 (2024-06-24)
- 初始版本
- 支持基本的1688订单导入功能
- 自动创建供应商和产品

## 许可证

LGPL-3

## 作者

Your Company

---

**注意**：本模块为第三方开发，非1688或Odoo官方产品。使用前请先在测试环境中验证功能。
